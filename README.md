# Artifacts for "An Abstract Interpretation for SIMD Divergence on Reducible Control Flow Graphs"

Our paper is accompanied by two artifacts:

1. A Coq **mechanization** of most of the paper's definitions and theorems.
2. An implementation of our analysis within the LLVM compiler and a **quantitative evaluation** of its precision and compile-time impact.

## Mechanized Proofs

The mechanized proofs have their own GitHub [repository](https://github.com/cdl-saarland/uniana).
This repository includes a README explaining how to compile the Coq proofs.
The CoqDoc of the development is generated by the included Makefile, but can also be investigated [here](https://compilers.cs.uni-saarland.de/projects/uniana/toc.html).

## Quantitative Evaluation

The following assumes that you are running Docker on a `x86_64` host machine.
We provide a docker image with additional scripts to build all binaries and run the evaluation.
There are three main steps once you have the Docker image running:
- First, you build LLVM, the OpenCL driver, the AnyDSL compiler stack and the OpenCL benchmarks.
The OpenCL driver (pocl) and Thorin (AnyDSL) are modified to dump the compute kernel LLVM IR whenever an OpenCL application is run (or an AnyDSL application gets compiled).
- In the second step, you use the compilers and OpenCL benchmarks from the first step to extract the compute kernels for later analysis.
- Finally, you run the divergence analysis tool (dacomp).
The last script invocation will end with a rendering of the evaluation tables (Figure 5 and Figure 6).

#### Get the Docker image

TODO: URL

### Launch the Docker image

The docker image needs to be attached your X-Server (required for LuxMark).
This command will also open a bash inside the Docker container.
Keep it open for the next steps.

    docker run -ti --rm -e DISPLAY=${DISPLAY} -v /tmp/.X11-unix:/tmp/.X11-unix popl21_eval


### [Optional] Copy your ISO file of SPEC ACCEL 1.3

Due to licensing issues, we cannot provide [SPEC ACCEL 1.3](https://www.spec.org/accel/) with the Docker image.
However, there is a script to plug-in your own copy of the benchmark suite.
If you have the SPEC ACCEL 1.3 ISO file, run the following commands outside the Docker container to load and install it inside the running Docker container.

Mount the ISO file (`accel-1.3.iso`) on your host system as a loop device.

    mkdir -p ~/iso
    sudo mount accel-1.3.iso ~/iso -o loop

Query the ID of the running Docker container (from a shell that is running outside the container):

    docker ps

Then, copy the contents of the ISO into the container (at ~/iso).

    docker cp ~/iso <container_id>:/home/theuser/iso/

Now, in the running container shell (still at `~/workspace`), run the following command to integrate SPEC ACCEL into the evaluation system:

    bash install_spec.sh

### Build Compilers and OpenCL host applications

Inside to the docker shell run

    bash ./build.sh

### Extract the Kernels

    bash ./extract_kernels.sh

### Extract the LuxMark Kernels

We provide the extracted LLVM IR for the LuxMark kernels in our image.
To copy them to the dump folder, call:

    bash ./copy_luxmark_kernels.sh

(We provide instructions below on how to extract the LuxMark OpenCL IR kernels yourself)



### Transfer the dumped kernels to the analysis folder

This will copy the extracted SPMD kernels into the input folder of dacomp, the Divergence Analysis tool.

    bash ./transfer_kernels.sh

### Evaluate the Divergence Analysis Configuration

Finally, run the next line to start the actual evaluation.
This will evaluate all divergence analysis configuration on the transfered kernel files.

    bash ./evaluate.sh

The variable `NUM_SAMPLES` is used in this script to configure the number of sample runs.
Make sure to turn off hyper threading and turbo boost to get better timing results.
When the script has finished (which may take a while for `NUM_SAMPLES=50`), it will print a result table similar to Figure 5 and 6 in the paper.
The table is stored in `~/workspace/result_tables.txt`.



### [Optional] LuxMark kernel extraction
We provide pre-extracted OpenCL kernels (as LLVM IR) for LuxMark since its build prerequesites and setup blow up the image substantially.
In case, you want to extract the kernels yourself, first make sure that you can run Docker OpenGL applications with your setup (the steps depend on your host system and gpu).
LuxMark is a GUI application and needs your input to launch the OpenCL driver.

First, build luxmark with the command

    bash ./build_luxmark.sh

When you are prompted for the root passwort, enter `theuser`. LuxMark requires a lot more packages to build and run then the rest of the setup.
To run the luxmark binary, launch the following script, which will already set it up with our OpenCL driver for kernel extraction:

    bash ./extract_luxmark_kernels.sh

Then, in the GUI, configure LuxMark for OpenCL over CPU and start it.
After a while all kernel modules have been exported.
You can end LuxMark as soon as it starts rendering.
